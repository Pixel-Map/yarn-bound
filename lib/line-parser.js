"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// @ts-nocheck
// mutates node, processing [markup /] and `character:`
function parseLine(node, locale) {
    node.markup = [];
    parseCharacterLabel(node);
    parseMarkup(node, locale);
    node.text = node.text.replace(/(?:\\(.))/g, '$1');
}
exports.default = parseLine;
function parseCharacterLabel(node) {
    const match = node.text.match(/^(\S+):\s+/);
    if (match) {
        node.text = node.text.replace(match[0], '');
        node.markup.push({ name: 'character', properties: { name: match[1] } });
    }
}
function parseMarkup(node, locale) {
    const attributes = [];
    let noMarkup = false;
    const attributeRegex = /(^|[^\\])\[(.*?[^\\])\](.|$)/;
    let textRemaining = node.text;
    let resultText = '';
    let match = textRemaining.match(attributeRegex);
    while (match) {
        const { index } = match;
        const [wholeMatch, charBefore, contents, charAfter] = match;
        const hasLeadingSpace = /\s/.test(charBefore);
        const hasTrailingSpace = /\s/.test(charAfter);
        const attribute = {
            ...parseAttributeContents(contents, locale),
            position: resultText.length + index + charBefore.length,
        };
        if (!noMarkup || attribute.name === 'nomarkup') {
            const isReplacementTag = attribute.name === 'select' || attribute.name === 'plural' || attribute.name === 'ordinal';
            const shouldTrim = !isReplacementTag &&
                attribute.isSelfClosing &&
                attribute.properties &&
                attribute.properties.trimwhitespace !== false &&
                ((index === 0 && hasTrailingSpace) || (hasLeadingSpace && hasTrailingSpace));
            if (attribute.properties) {
                delete attribute.properties.trimwhitespace;
            }
            const replacement = charBefore + (attribute.replacement || '') + (shouldTrim ? charAfter.slice(1) : charAfter);
            textRemaining = textRemaining.replace(attributeRegex, replacement);
            // inner slices are because charAfter could be an opening square bracket
            resultText += textRemaining.slice(0, index + replacement.slice(1).length);
            textRemaining = textRemaining.slice(index + replacement.slice(1).length);
            if (!isReplacementTag && attribute.name !== 'nomarkup') {
                attributes.push(attribute);
            }
        }
        else {
            // -1s are because charAfter could be an opening square bracket
            resultText += textRemaining.slice(0, index + wholeMatch.length - 1);
            textRemaining = textRemaining.slice(index + wholeMatch.length - 1);
        }
        if (attribute.name === 'nomarkup') {
            noMarkup = !attribute.isClosing;
        }
        match = textRemaining.match(attributeRegex);
    }
    node.text = resultText + textRemaining;
    // Escaped bracket support might need some TLC.
    const escapedCharacterRegex = /\\(\[|\])/;
    match = node.text.match(escapedCharacterRegex);
    textRemaining = node.text;
    resultText = '';
    while (match) {
        const char = match[1];
        attributes.forEach((attr) => {
            if (attr.position > resultText.length + match.index) {
                attr.position -= 1;
            }
        });
        textRemaining = textRemaining.replace(escapedCharacterRegex, char);
        resultText += textRemaining.slice(0, match.index + 1);
        textRemaining = textRemaining.slice(match.index + 1);
        match = textRemaining.match(escapedCharacterRegex);
    }
    node.text = resultText + textRemaining;
    const openTagStacks = {};
    attributes.forEach((attr) => {
        if (!openTagStacks[attr.name]) {
            openTagStacks[attr.name] = [];
        }
        if (attr.isClosing && !openTagStacks[attr.name].length) {
            throw new Error(`Encountered closing ${attr.name} tag before opening tag`);
        }
        else if (attr.isClosing) {
            const openTag = openTagStacks[attr.name].pop();
            node.markup.push({
                name: openTag.name,
                position: openTag.position,
                properties: openTag.properties,
                length: attr.position - openTag.position,
            });
        }
        else if (attr.isSelfClosing) {
            node.markup.push({
                name: attr.name,
                position: attr.position,
                properties: attr.properties,
                length: 0,
            });
        }
        else if (attr.isCloseAll) {
            const openTags = Object.values(openTagStacks).flat();
            while (openTags.length) {
                const openTag = openTags.pop();
                node.markup.push({
                    name: openTag.name,
                    position: openTag.position,
                    properties: openTag.properties,
                    length: attr.position - openTag.position,
                });
            }
        }
        else {
            openTagStacks[attr.name].push({
                name: attr.name,
                position: attr.position,
                properties: attr.properties,
            });
        }
    });
}
function parseAttributeContents(contents, locale) {
    const nameMatch = contents.match(/^\/?([^\s=/]+)(\/|\s|$)/);
    const isClosing = contents[0] === '/';
    const isSelfClosing = contents[contents.length - 1] === '/';
    const isCloseAll = contents === '/';
    if (isCloseAll) {
        return { name: 'closeall', isCloseAll: true };
    }
    else if (isClosing) {
        return { name: nameMatch[1], isClosing: true };
    }
    else {
        const propertyAssignmentsText = nameMatch ? contents.replace(nameMatch[0], '') : contents;
        const propertyAssignments = propertyAssignmentsText.match(/(\S+?".*?"|[^\s/]+)/g);
        let properties = {};
        if (propertyAssignments) {
            properties = propertyAssignments.reduce((acc, propAss) => {
                return { ...acc, ...parsePropertyAssignment(propAss) };
            }, {});
        }
        const name = (nameMatch && nameMatch[1]) || Object.keys(properties)[0];
        let replacement;
        if (name === 'select') {
            replacement = processSelectAttribute(properties);
        }
        else if (name === 'plural') {
            replacement = processPluralAttribute(properties, locale);
        }
        else if (name === 'ordinal') {
            replacement = processOrdinalAttribute(properties, locale);
        }
        return {
            name,
            properties,
            isSelfClosing,
            replacement,
        };
    }
}
function parsePropertyAssignment(propAss) {
    const [propName, ...rest] = propAss.split('=');
    const stringValue = rest.join('='); // just in case string value had a = in it
    if (!propName || !stringValue) {
        throw new Error(`Invalid markup property assignment: ${propAss}`);
    }
    let value;
    if (stringValue === 'true' || stringValue === 'false') {
        value = stringValue === 'true';
    }
    else if (/^-?\d*\.?\d+$/.test(stringValue)) {
        value = +stringValue;
    }
    else if (stringValue[0] === '"' && stringValue[stringValue.length - 1] === '"') {
        value = stringValue.slice(1, -1);
    }
    else {
        value = stringValue;
    }
    return { [propName]: value };
}
function processSelectAttribute(properties) {
    return properties[properties.value];
}
function processPluralAttribute(properties, locale) {
    return properties[new Intl.PluralRules(locale).select(properties.value)].replace(/%/g, properties.value);
}
function processOrdinalAttribute(properties, locale) {
    return properties[new Intl.PluralRules(locale, { type: 'ordinal' }).select(properties.value)].replace(/%/g, properties.value);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGluZS1wYXJzZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbGluZS1wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxjQUFjO0FBQ2QsdURBQXVEO0FBQ3ZELFNBQXdCLFNBQVMsQ0FBQyxJQUFJLEVBQUUsTUFBTTtJQUM1QyxJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztJQUNqQixtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMxQixXQUFXLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzFCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3BELENBQUM7QUFMRCw0QkFLQztBQUVELFNBQVMsbUJBQW1CLENBQUMsSUFBSTtJQUMvQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUM1QyxJQUFJLEtBQUssRUFBRTtRQUNULElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQ3pFO0FBQ0gsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLElBQUksRUFBRSxNQUFNO0lBQy9CLE1BQU0sVUFBVSxHQUFHLEVBQUUsQ0FBQztJQUN0QixJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUM7SUFFckIsTUFBTSxjQUFjLEdBQUcsOEJBQThCLENBQUM7SUFDdEQsSUFBSSxhQUFhLEdBQUcsSUFBSSxDQUFDLElB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QyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUMzRyxDQUFDO0FBRUQsU0FBUyx1QkFBdUIsQ0FBQyxVQUFVLEVBQUUsTUFBTTtJQUNqRCxPQUFPLFVBQVUsQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FDbkcsSUFBSSxFQUNKLFVBQVUsQ0FBQyxLQUFLLENBQ2pCLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQHRzLW5vY2hlY2tcbi8vIG11dGF0ZXMgbm9kZSwgcHJvY2Vzc2luZyBbbWFya3VwIC9dIGFuZCBgY2hhcmFjdGVyOmBcbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHBhcnNlTGluZShub2RlLCBsb2NhbGUpIHtcbiAgbm9kZS5tYXJrdXAgPSBbXTtcbiAgcGFyc2VDaGFyYWN0ZXJMYWJlbChub2RlKTtcbiAgcGFyc2VNYXJrdXAobm9kZSwgbG9jYWxlKTtcbiAgbm9kZS50ZXh0ID0gbm9kZS50ZXh0LnJlcGxhY2UoLyg/OlxcXFwoLikpL2csICckMScpO1xufVxuXG5mdW5jdGlvbiBwYXJzZUNoYXJhY3RlckxhYmVsKG5vZGUpIHtcbiAgY29uc3QgbWF0Y2ggPSBub2RlLnRleHQubWF0Y2goL14oXFxTKyk6XFxzKy8pO1xuICBpZiAobWF0Y2gpIHtcbiAgICBub2RlLnRleHQgPSBub2RlLnRleHQucmVwbGFjZShtYXRjaFswXSwgJycpO1xuICAgIG5vZGUubWFya3VwLnB1c2goeyBuYW1lOiAnY2hhcmFjdGVyJywgcHJvcGVydGllczogeyBuYW1lOiBtYXRjaFsxXSB9IH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIHBhcnNlTWFya3VwKG5vZGUsIGxvY2FsZSkge1xuICBjb25zdCBhdHRyaWJ1dGVzID0gW107XG4gIGxldCBub01hcmt1cCA9IGZhbHNlO1xuXG4gIGNvbnN0IGF0dHJpYnV0ZVJlZ2V4ID0gLyhefFteXFxcXF0pXFxbKC4qP1teXFxcXF0pXFxdKC58JCkvO1xuICBsZXQgdGV4dFJlbWFpbmluZyA9IG5vZGUudGV4dDtcbiAgbGV0IHJlc3VsdFRleHQgPSAnJztcbiAgbGV0IG1hdGNoID0gdGV4dFJlbWFpbmluZy5tYXRjaChhdHRyaWJ1dGVSZWdleCk7XG4gIHdoaWxlIChtYXRjaCkge1xuICAgIGNvbnN0IHsgaW5kZXggfSA9IG1hdGNoO1xuICAgIGNvbnN0IFt3aG9sZU1hdGNoLCBjaGFyQmVmb3JlLCBjb250ZW50cywgY2hhckFmdGVyXSA9IG1hdGNoO1xuICAgIGNvbnN0IGhhc0xlYWRpbmdTcGFjZSA9IC9cXHMvLnRlc3QoY2hhckJlZm9yZSk7XG4gICAgY29uc3QgaGFzVHJhaWxpbmdTcGFjZSA9IC9cXHMvLnRlc3QoY2hhckFmdGVyKTtcblxuICAgIGNvbnN0IGF0dHJpYnV0ZSA9IHtcbiAgICAgIC4uLnBhcnNlQXR0cmlidXRlQ29udGVudHMoY29udGVudHMsIGxvY2FsZSksXG4gICAgICBwb3NpdGlvbjogcmVzdWx0VGV4dC5sZW5ndGggKyBpbmRleCArIGNoYXJCZWZvcmUubGVuZ3RoLFxuICAgIH07XG5cbiAgICBpZiAoIW5vTWFya3VwIHx8IGF0dHJpYnV0ZS5uYW1lID09PSAnbm9tYXJrdXAnKSB7XG4gICAgICBjb25zdCBpc1JlcGxhY2VtZW50VGFnID1cbiAgICAgICAgYXR0cmlidXRlLm5hbWUgPT09ICdzZWxlY3QnIHx8IGF0dHJpYnV0ZS5uYW1lID09PSAncGx1cmFsJyB8fCBhdHRyaWJ1dGUubmFtZSA9PT0gJ29yZGluYWwnO1xuICAgICAgY29uc3Qgc2hvdWxkVHJpbSA9XG4gICAgICAgICFpc1JlcGxhY2VtZW50VGFnICYmXG4gICAgICAgIGF0dHJpYnV0ZS5pc1NlbGZDbG9zaW5nICYmXG4gICAgICAgIGF0dHJpYnV0ZS5wcm9wZXJ0aWVzICYmXG4gICAgICAgIGF0dHJpYnV0ZS5wcm9wZXJ0aWVzLnRyaW13aGl0ZXNwYWNlICE9PSBmYWxzZSAmJlxuICAgICAgICAoKGluZGV4ID09PSAwICYmIGhhc1RyYWlsaW5nU3BhY2UpIHx8IChoYXNMZWFkaW5nU3BhY2UgJiYgaGFzVHJhaWxpbmdTcGFjZSkpO1xuICAgICAgaWYgKGF0dHJpYnV0ZS5wcm9wZXJ0aWVzKSB7XG4gICAgICAgIGRlbGV0ZSBhdHRyaWJ1dGUucHJvcGVydGllcy50cmltd2hpdGVzcGFjZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gY2hhckJlZm9yZSArIChhdHRyaWJ1dGUucmVwbGFjZW1lbnQgfHwgJycpICsgKHNob3VsZFRyaW0gPyBjaGFyQWZ0ZXIuc2xpY2UoMSkgOiBjaGFyQWZ0ZXIpO1xuXG4gICAgICB0ZXh0UmVtYWluaW5nID0gdGV4dFJlbWFpbmluZy5yZXBsYWNlKGF0dHJpYnV0ZVJlZ2V4LCByZXBsYWNlbWVudCk7XG4gICAgICAvLyBpbm5lciBzbGljZXMgYXJlIGJlY2F1c2UgY2hhckFmdGVyIGNvdWxkIGJlIGFuIG9wZW5pbmcgc3F1YXJlIGJyYWNrZXRcbiAgICAgIHJlc3VsdFRleHQgKz0gdGV4dFJlbWFpbmluZy5zbGljZSgwLCBpbmRleCArIHJlcGxhY2VtZW50LnNsaWNlKDEpLmxlbmd0aCk7XG4gICAgICB0ZXh0UmVtYWluaW5nID0gdGV4dFJlbWFpbmluZy5zbGljZShpbmRleCArIHJlcGxhY2VtZW50LnNsaWNlKDEpLmxlbmd0aCk7XG4gICAgICBpZiAoIWlzUmVwbGFjZW1lbnRUYWcgJiYgYXR0cmlidXRlLm5hbWUgIT09ICdub21hcmt1cCcpIHtcbiAgICAgICAgYXR0cmlidXRlcy5wdXNoKGF0dHJpYnV0ZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIC0xcyBhcmUgYmVjYXVzZSBjaGFyQWZ0ZXIgY291bGQgYmUgYW4gb3BlbmluZyBzcXVhcmUgYnJhY2tldFxuICAgICAgcmVzdWx0VGV4dCArPSB0ZXh0UmVtYWluaW5nLnNsaWNlKDAsIGluZGV4ICsgd2hvbGVNYXRjaC5sZW5ndGggLSAxKTtcbiAgICAgIHRleHRSZW1haW5pbmcgPSB0ZXh0UmVtYWluaW5nLnNsaWNlKGluZGV4ICsgd2hvbGVNYXRjaC5sZW5ndGggLSAxKTtcbiAgICB9XG5cbiAgICBpZiAoYXR0cmlidXRlLm5hbWUgPT09ICdub21hcmt1cCcpIHtcbiAgICAgIG5vTWFya3VwID0gIWF0dHJpYnV0ZS5pc0Nsb3Npbmc7XG4gICAgfVxuXG4gICAgbWF0Y2ggPSB0ZXh0UmVtYWluaW5nLm1hdGNoKGF0dHJpYnV0ZVJlZ2V4KTtcbiAgfVxuXG4gIG5vZGUudGV4dCA9IHJlc3VsdFRleHQgKyB0ZXh0UmVtYWluaW5nO1xuXG4gIC8vIEVzY2FwZWQgYnJhY2tldCBzdXBwb3J0IG1pZ2h0IG5lZWQgc29tZSBUTEMuXG4gIGNvbnN0IGVzY2FwZWRDaGFyYWN0ZXJSZWdleCA9IC9cXFxcKFxcW3xcXF0pLztcbiAgbWF0Y2ggPSBub2RlLnRleHQubWF0Y2goZXNjYXBlZENoYXJhY3RlclJlZ2V4KTtcbiAgdGV4dFJlbWFpbmluZyA9IG5vZGUudGV4dDtcbiAgcmVzdWx0VGV4dCA9ICcnO1xuICB3aGlsZSAobWF0Y2gpIHtcbiAgICBjb25zdCBjaGFyID0gbWF0Y2hbMV07XG4gICAgYXR0cmlidXRlcy5mb3JFYWNoKChhdHRyKSA9PiB7XG4gICAgICBpZiAoYXR0ci5wb3NpdGlvbiA+IHJlc3VsdFRleHQubGVuZ3RoICsgbWF0Y2guaW5kZXgpIHtcbiAgICAgICAgYXR0ci5wb3NpdGlvbiAtPSAxO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRleHRSZW1haW5pbmcgPSB0ZXh0UmVtYWluaW5nLnJlcGxhY2UoZXNjYXBlZENoYXJhY3RlclJlZ2V4LCBjaGFyKTtcbiAgICByZXN1bHRUZXh0ICs9IHRleHRSZW1haW5pbmcuc2xpY2UoMCwgbWF0Y2guaW5kZXggKyAxKTtcbiAgICB0ZXh0UmVtYWluaW5nID0gdGV4dFJlbWFpbmluZy5zbGljZShtYXRjaC5pbmRleCArIDEpO1xuXG4gICAgbWF0Y2ggPSB0ZXh0UmVtYWluaW5nLm1hdGNoKGVzY2FwZWRDaGFyYWN0ZXJSZWdleCk7XG4gIH1cblxuICBub2RlLnRleHQgPSByZXN1bHRUZXh0ICsgdGV4dFJlbWFpbmluZztcblxuICBjb25zdCBvcGVuVGFnU3RhY2tzID0ge307XG4gIGF0dHJpYnV0ZXMuZm9yRWFjaCgoYXR0cikgPT4ge1xuICAgIGlmICghb3BlblRhZ1N0YWNrc1thdHRyLm5hbWVdKSB7XG4gICAgICBvcGVuVGFnU3RhY2tzW2F0dHIubmFtZV0gPSBbXTtcbiAgICB9XG5cbiAgICBpZiAoYXR0ci5pc0Nsb3NpbmcgJiYgIW9wZW5UYWdTdGFja3NbYXR0ci5uYW1lXS5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRW5jb3VudGVyZWQgY2xvc2luZyAke2F0dHIubmFtZX0gdGFnIGJlZm9yZSBvcGVuaW5nIHRhZ2ApO1xuICAgIH0gZWxzZSBpZiAoYXR0ci5pc0Nsb3NpbmcpIHtcbiAgICAgIGNvbnN0IG9wZW5UYWcgPSBvcGVuVGFnU3RhY2tzW2F0dHIubmFtZV0ucG9wKCk7XG4gICAgICBub2RlLm1hcmt1cC5wdXNoKHtcbiAgICAgICAgbmFtZTogb3BlblRhZy5uYW1lLFxuICAgICAgICBwb3NpdGlvbjogb3BlblRhZy5wb3NpdGlvbixcbiAgICAgICAgcHJvcGVydGllczogb3BlblRhZy5wcm9wZXJ0aWVzLFxuICAgICAgICBsZW5ndGg6IGF0dHIucG9zaXRpb24gLSBvcGVuVGFnLnBvc2l0aW9uLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChhdHRyLmlzU2VsZkNsb3NpbmcpIHtcbiAgICAgIG5vZGUubWFya3VwLnB1c2goe1xuICAgICAgICBuYW1lOiBhdHRyLm5hbWUsXG4gICAgICAgIHBvc2l0aW9uOiBhdHRyLnBvc2l0aW9uLFxuICAgICAgICBwcm9wZXJ0aWVzOiBhdHRyLnByb3BlcnRpZXMsXG4gICAgICAgIGxlbmd0aDogMCxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoYXR0ci5pc0Nsb3NlQWxsKSB7XG4gICAgICBjb25zdCBvcGVuVGFncyA9IE9iamVjdC52YWx1ZXMob3BlblRhZ1N0YWNrcykuZmxhdCgpO1xuICAgICAgd2hpbGUgKG9wZW5UYWdzLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBvcGVuVGFnID0gb3BlblRhZ3MucG9wKCk7XG4gICAgICAgIG5vZGUubWFya3VwLnB1c2goe1xuICAgICAgICAgIG5hbWU6IG9wZW5UYWcubmFtZSxcbiAgICAgICAgICBwb3NpdGlvbjogb3BlblRhZy5wb3NpdGlvbixcbiAgICAgICAgICBwcm9wZXJ0aWVzOiBvcGVuVGFnLnByb3BlcnRpZXMsXG4gICAgICAgICAgbGVuZ3RoOiBhdHRyLnBvc2l0aW9uIC0gb3BlblRhZy5wb3NpdGlvbixcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIG9wZW5UYWdTdGFja3NbYXR0ci5uYW1lXS5wdXNoKHtcbiAgICAgICAgbmFtZTogYXR0ci5uYW1lLFxuICAgICAgICBwb3NpdGlvbjogYXR0ci5wb3NpdGlvbixcbiAgICAgICAgcHJvcGVydGllczogYXR0ci5wcm9wZXJ0aWVzLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcGFyc2VBdHRyaWJ1dGVDb250ZW50cyhjb250ZW50cywgbG9jYWxlKSB7XG4gIGNvbnN0IG5hbWVNYXRjaCA9IGNvbnRlbnRzLm1hdGNoKC9eXFwvPyhbXlxccz0vXSspKFxcL3xcXHN8JCkvKTtcbiAgY29uc3QgaXNDbG9zaW5nID0gY29udGVudHNbMF0gPT09ICcvJztcbiAgY29uc3QgaXNTZWxmQ2xvc2luZyA9IGNvbnRlbnRzW2NvbnRlbnRzLmxlbmd0aCAtIDFdID09PSAnLyc7XG4gIGNvbnN0IGlzQ2xvc2VBbGwgPSBjb250ZW50cyA9PT0gJy8nO1xuICBpZiAoaXNDbG9zZUFsbCkge1xuICAgIHJldHVybiB7IG5hbWU6ICdjbG9zZWFsbCcsIGlzQ2xvc2VBbGw6IHRydWUgfTtcbiAgfSBlbHNlIGlmIChpc0Nsb3NpbmcpIHtcbiAgICByZXR1cm4geyBuYW1lOiBuYW1lTWF0Y2hbMV0sIGlzQ2xvc2luZzogdHJ1ZSB9O1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHByb3BlcnR5QXNzaWdubWVudHNUZXh0ID0gbmFtZU1hdGNoID8gY29udGVudHMucmVwbGFjZShuYW1lTWF0Y2hbMF0sICcnKSA6IGNvbnRlbnRzO1xuICAgIGNvbnN0IHByb3BlcnR5QXNzaWdubWVudHMgPSBwcm9wZXJ0eUFzc2lnbm1lbnRzVGV4dC5tYXRjaCgvKFxcUys/XCIuKj9cInxbXlxccy9dKykvZyk7XG4gICAgbGV0IHByb3BlcnRpZXMgPSB7fTtcbiAgICBpZiAocHJvcGVydHlBc3NpZ25tZW50cykge1xuICAgICAgcHJvcGVydGllcyA9IHByb3BlcnR5QXNzaWdubWVudHMucmVkdWNlKChhY2MsIHByb3BBc3MpID0+IHtcbiAgICAgICAgcmV0dXJuIHsgLi4uYWNjLCAuLi5wYXJzZVByb3BlcnR5QXNzaWdubWVudChwcm9wQXNzKSB9O1xuICAgICAgfSwge30pO1xuICAgIH1cblxuICAgIGNvbnN0IG5hbWUgPSAobmFtZU1hdGNoICYmIG5hbWVNYXRjaFsxXSkgfHwgT2JqZWN0LmtleXMocHJvcGVydGllcylbMF07XG5cbiAgICBsZXQgcmVwbGFjZW1lbnQ7XG4gICAgaWYgKG5hbWUgPT09ICdzZWxlY3QnKSB7XG4gICAgICByZXBsYWNlbWVudCA9IHByb2Nlc3NTZWxlY3RBdHRyaWJ1dGUocHJvcGVydGllcyk7XG4gICAgfSBlbHNlIGlmIChuYW1lID09PSAncGx1cmFsJykge1xuICAgICAgcmVwbGFjZW1lbnQgPSBwcm9jZXNzUGx1cmFsQXR0cmlidXRlKHByb3BlcnRpZXMsIGxvY2FsZSk7XG4gICAgfSBlbHNlIGlmIChuYW1lID09PSAnb3JkaW5hbCcpIHtcbiAgICAgIHJlcGxhY2VtZW50ID0gcHJvY2Vzc09yZGluYWxBdHRyaWJ1dGUocHJvcGVydGllcywgbG9jYWxlKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIHByb3BlcnRpZXMsXG4gICAgICBpc1NlbGZDbG9zaW5nLFxuICAgICAgcmVwbGFjZW1lbnQsXG4gICAgfTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZVByb3BlcnR5QXNzaWdubWVudChwcm9wQXNzKSB7XG4gIGNvbnN0IFtwcm9wTmFtZSwgLi4ucmVzdF0gPSBwcm9wQXNzLnNwbGl0KCc9Jyk7XG4gIGNvbnN0IHN0cmluZ1ZhbHVlID0gcmVzdC5qb2luKCc9Jyk7IC8vIGp1c3QgaW4gY2FzZSBzdHJpbmcgdmFsdWUgaGFkIGEgPSBpbiBpdFxuICBpZiAoIXByb3BOYW1lIHx8ICFzdHJpbmdWYWx1ZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBtYXJrdXAgcHJvcGVydHkgYXNzaWdubWVudDogJHtwcm9wQXNzfWApO1xuICB9XG4gIGxldCB2YWx1ZTtcbiAgaWYgKHN0cmluZ1ZhbHVlID09PSAndHJ1ZScgfHwgc3RyaW5nVmFsdWUgPT09ICdmYWxzZScpIHtcbiAgICB2YWx1ZSA9IHN0cmluZ1ZhbHVlID09PSAndHJ1ZSc7XG4gIH0gZWxzZSBpZiAoL14tP1xcZCpcXC4/XFxkKyQvLnRlc3Qoc3RyaW5nVmFsdWUpKSB7XG4gICAgdmFsdWUgPSArc3RyaW5nVmFsdWU7XG4gIH0gZWxzZSBpZiAoc3RyaW5nVmFsdWVbMF0gPT09ICdcIicgJiYgc3RyaW5nVmFsdWVbc3RyaW5nVmFsdWUubGVuZ3RoIC0gMV0gPT09ICdcIicpIHtcbiAgICB2YWx1ZSA9IHN0cmluZ1ZhbHVlLnNsaWNlKDEsIC0xKTtcbiAgfSBlbHNlIHtcbiAgICB2YWx1ZSA9IHN0cmluZ1ZhbHVlO1xuICB9XG4gIHJldHVybiB7IFtwcm9wTmFtZV06IHZhbHVlIH07XG59XG5cbmZ1bmN0aW9uIHByb2Nlc3NTZWxlY3RBdHRyaWJ1dGUocHJvcGVydGllcykge1xuICByZXR1cm4gcHJvcGVydGllc1twcm9wZXJ0aWVzLnZhbHVlXTtcbn1cblxuZnVuY3Rpb24gcHJvY2Vzc1BsdXJhbEF0dHJpYnV0ZShwcm9wZXJ0aWVzLCBsb2NhbGUpIHtcbiAgcmV0dXJuIHByb3BlcnRpZXNbbmV3IEludGwuUGx1cmFsUnVsZXMobG9jYWxlKS5zZWxlY3QocHJvcGVydGllcy52YWx1ZSldLnJlcGxhY2UoLyUvZywgcHJvcGVydGllcy52YWx1ZSk7XG59XG5cbmZ1bmN0aW9uIHByb2Nlc3NPcmRpbmFsQXR0cmlidXRlKHByb3BlcnRpZXMsIGxvY2FsZSkge1xuICByZXR1cm4gcHJvcGVydGllc1tuZXcgSW50bC5QbHVyYWxSdWxlcyhsb2NhbGUsIHsgdHlwZTogJ29yZGluYWwnIH0pLnNlbGVjdChwcm9wZXJ0aWVzLnZhbHVlKV0ucmVwbGFjZShcbiAgICAvJS9nLFxuICAgIHByb3BlcnRpZXMudmFsdWUsXG4gICk7XG59XG4iXX0=